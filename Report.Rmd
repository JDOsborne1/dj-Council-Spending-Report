---
title: "Report on Large Spending by South Glos Council"
author: "Joseph Osborne"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

This report will investigate the spending patterns of South Gloucestershire Council using the data provided by said council [here](https://www.southglos.gov.uk/business/tenders-and-contracts/how-we-spend-our-money/council-payments-over-500/). 

I will use this data to answer the following questions:

1. Who are the most significant recipients of council payments?
1. Does the volume of outgoings change over time?
1. Is the majority of the total outgoing value made up of small payments?


## Data Sourcing

This report leverages R to scrape the above webpage for the data links and brings all the data together to support any conclusions. The code is abstracted for the purposes of clarity, but can be viewed and reused at leisure [here](http://a.link.webpage/).

One comment to be made is that while there seems to be a standard across open data providers to make the data available in monthly or quarterly chunks, those chunks are themselves rarely uniform. In the case of this data, there appears to be a minimal or inconsistent standard in naming files. In addition, the column names change between data which is ostensibly recording the same information. In some cases, there are files which have been saved as .xlsx format and which have additional empty sheets which serve no purpose. These files have then simply been renamed to .csv format. 


## - TESTING SECTION 

```{r Obtain the links}
source(here::here("R/extract_functions.R"))

links <- generateLinksFromPage("https://www.southglos.gov.uk/business/tenders-and-contracts/how-we-spend-our-money/council-payments-over-500/")

```

```{r Extracting data from page}

extract <- links %>% 
        dplyr::filter(link != "http://www.southglos.gov.uk//documents/2-May-2018-Invoices-ALL-Paid-over-Â£500-for-web-publish.csv") %>% 
        tail(40) %>% 
        dataExtraction(control_links = F)




```

```{r Munging and refining the extracted data}

refined_extract <- extract %>% 
        refineData()
        
```

```{r Generating a basic view of the spending}
library(dplyr)
date_level_spending_data <- refined_extract %>% 
        group_by(Payment.date) %>% 
        summarise(Total.Spend = sum(GL.Code.Net.Amount))



```

```{r experimenting with the plot}
library(ggplot2)
date_level_spending_plot <- date_level_spending_data %>% 
        ggplot(aes(x = Payment.date, y = Total.Spend)) +
        geom_line(colour = '#CC2D2D',size = 2,linetype = 1,alpha = 0.67) + 
    theme_classic() +
    theme(
        plot.subtitle = element_text(size = 13, hjust = 0.01, vjust = 1)
        , plot.caption = element_text(vjust = 1)#
        , axis.ticks = element_line(colour = "black")
        , axis.title = element_text(face = "bold")
        , axis.text = element_text(face = "bold")
        , plot.title = element_text(face = "bold")
        ) + 
    labs(
        title = "Total Daily Spend"
        , x = "Payment Day"
        , y = "Total Spend"
        , subtitle = "The total council spend across all recipient categories"
        , caption = "Source: South Gloucestershire Council"
        )
date_level_spending_plot
```

-- Construct a specialised reader function which wraps both read_csv and read_excel. Also need to adjust for the 404 failures of certain extractions
Will need to customise either curl::curl_download or download.file



```{r}
readr::problems(
    
"http://hosted.southglos.gov.uk/councilpayments/november10.csv" %>% 
    customDataReader()
)
```


